{% extends 'layout.html' %}

{% block title %}
  Estimate And Evaluate Yourself
{% endblock %}

{% block content %}
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include Select2 CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
  form {
    max-width: 1000px;
    margin: 0 auto 30px auto;
    padding: 25px;
    background: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 15px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  label {
    font-weight: 600;
    margin-bottom: 6px;
    color: #333;
  }

  input[type='text'],
  input[type='email'],
  input[type='number'],
  textarea,select
   {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
    box-sizing: border-box;
    transition: border-color 0.3s ease;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 5px rgba(59, 130, 246, 0.4);
  }
  

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  @media (max-width: 640px) {
    .form-row {
      grid-template-columns: 1fr;
    }

    form {
      padding: 15px;
      margin: 10px;
    }
  }

  button[type='submit'] {
    background-color: #3b82f6;
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 5px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button[type='submit']:hover {
    background-color: #2563eb;
  }

  #other-type-wrapper,
  #other-existing-wrapper {
    display: none;
  }

  .select2-results__option {
    user-select: none;
    cursor: default;
  }

  .select-all-option {
    font-weight: 600;
    border-bottom: 1px solid #ddd;
    padding: 8px 12px;
    background: white !important;
  }
</style>

<div class="container mt-5">
  <div class="row">
    <form method="POST">
      {% csrf_token %}

      <div class="form-row">
        <div class="form-group">{{ form.name }}</div>
        <div class="form-group">{{ form.company_name }}</div>
        <div class="form-group">{{ form.branches }}</div>
      </div>

      <div class="form-row">
        <div class="form-group">{{ form.location }}</div>
        <div class="form-group">{{ form.Employees_no }}</div>
        <div class="form-group">{{ form.turnover }}</div>
      </div>

      <div class="form-row">
        <div class="form-group">{{ form.designation }}</div>
        <div class="form-group">{{ form.mobile_no }}</div>
        <div class="form-group">{{ form.email }}</div>
      </div>

      <div class="form-row">
        <div class="form-group">{{ form.no_of_users }}</div>
        <div class="form-group">{{ form.product }}</div>
        <div class="form-group">{{ form.type }}</div>
      </div>

      <div class="form-row" id="other-type-wrapper">
        <div class="form-group">{{ form.type_other.label_tag }} {{ form.type_other }}</div>
      </div>

      <div class="form-row">
        <div class="form-group">{{ form.existing_appli }}</div>
        <div>
        
          <select id="id_module" name="module" multiple="multiple" class="select2-multi" ></select>
         
        </div>
      </div>

      <div class="form-row" id="other-existing-wrapper">
        <div class="form-group">{{ form.existing_appli_other.label_tag }} {{ form.existing_appli_other }}</div>
      </div>

      <button type="submit" style="align-self:center;">Submit</button>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const companyTypeSelect = document.getElementById('id_type');
    const otherCompanyWrapper = document.getElementById('other-type-wrapper');
    const existingAppliSelect = document.getElementById('id_existing_appli');
    const existingAppliOtherWrapper = document.getElementById('other-existing-wrapper');
    const productSelect = document.getElementById('id_product');
    const moduleSelect = $('#id_module');
    const selectedCountDiv = document.getElementById('selected-count');

    // Initialize Select2 with custom template
    moduleSelect.select2({
      placeholder: "Select modules...",
      closeOnSelect: false,
      templateResult: function (data) {
        if (!data.id) return data.text;
        const selectedValues = moduleSelect.val() || [];
        const checked = selectedValues.includes(data.id);

        const $result = $(`
          <div class="custom-select2-item">
            
            <span>${data.text}</span>
          </div>
        `);
        return $result;
      },
      templateSelection: function (data) {
        return data.text;
      },
      escapeMarkup: function (markup) {
        return markup;
      }
    });

   

   

    function toggleCompanyType() {
      otherCompanyWrapper.style.display = (companyTypeSelect?.selectedOptions[0]?.text.toLowerCase() === 'other') ? 'grid' : 'none';
    }

    function toggleExistingAppli() {
      existingAppliOtherWrapper.style.display = (existingAppliSelect?.value === 'Other') ? 'grid' : 'none';
    }

    function loadModules(productId) {
      moduleSelect.empty();
      fetch(`/get-modules/?product_id=${productId}`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            moduleSelect.append(new Option("No modules available", "", false, false));
          } else {
            data.forEach(mod => {
              moduleSelect.append(new Option(mod.name, mod.id, false, false));
            });
          }
          moduleSelect.trigger('change');
        })
        .catch(() => {
          moduleSelect.empty().append(new Option("Error loading modules", "", false, false)).trigger('change');
        });
    }

    if (companyTypeSelect) companyTypeSelect.addEventListener('change', toggleCompanyType);
    if (existingAppliSelect) existingAppliSelect.addEventListener('change', toggleExistingAppli);
    if (productSelect) productSelect.addEventListener('change', function () {
      loadModules(this.value);
    });

    toggleCompanyType();
    toggleExistingAppli();
    if (productSelect && productSelect.value) loadModules(productSelect.value);
    updateSelectedCount();
  });
</script>
{% endblock %}
